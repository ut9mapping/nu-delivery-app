import streamlit as st
import google.generativeai as genai
import gspread
import pandas as pd
from google.oauth2.service_account import Credentials
from streamlit_geolocation import streamlit_geolocation
from datetime import datetime

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
st.set_page_config(page_title="NU Professional Tracker", page_icon="üõµ", layout="wide")

# --- 1. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà Mapping ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ö‡∏≠‡∏Å (Strict Mapping) ---
NU_STRUCTURE = {
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 1 (‡∏ñ‡∏ô‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏°.)": {
        "‡∏ã‡∏≠‡∏¢‡πÇ‡∏ã‡∏ô‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏°.": {
            "‡∏ã‡∏≠‡∏¢‡∏ï‡∏¥‡∏î‡∏£‡∏±‡πâ‡∏ß": ["‡∏ù‡∏±‡πà‡∏á‡∏£‡∏±‡πâ‡∏ß (‡∏°‡∏µ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)"],
            "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ô‡∏±‡∏î‡∏î‡∏≤", "‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏≠‡∏£‡∏±‡∏™‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞", "‡∏ó‡∏≤‡∏á‡∏ó‡∏∞‡∏•‡∏∏‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á"],
            "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏ù‡πâ‡∏≤‡∏¢‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß": ["‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏ù‡πâ‡∏≤‡∏¢‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß", "‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏ù‡πâ‡∏≤‡∏¢"]
        }
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 5 ‡∏ñ‡∏∂‡∏á 6": {
        "‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏ó‡∏≤‡∏á‡πÅ‡∏¢‡∏Å (‡∏à‡∏≤‡∏Å ‡∏õ.5)": {
            "‡∏ã‡∏≠‡∏¢ NU Plaza": ["‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡πà‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°"],
            "‡∏ã‡∏≠‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏ä‡∏£‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î": ["‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡πà‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°"],
            "‡∏ã‡∏≠‡∏¢‡πÇ‡∏•‡∏Å‡∏µ‡∏¢‡πå": ["‡∏ù‡∏±‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏∑‡πà‡∏ô (‡∏ã‡∏≠‡∏¢‡πÅ‡∏ö‡∏•‡πá‡∏Ñ‡∏¢‡∏≤‡∏£‡πå‡∏î)", "‡∏ù‡∏±‡πà‡∏á‡∏õ‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏±‡∏ç (‡∏ã‡∏≠‡∏¢‡πÇ‡∏£‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î)", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°"]
        },
        "‡∏ó‡∏≤‡∏á‡πÅ‡∏¢‡∏Å‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ (‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß ‡∏õ.6)": {
            "NU1": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°"],
            "NU2": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°"],
            "NU3": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°"],
            "Pyland1": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°"],
            "Pyland2": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°"],
            "‡∏ã‡∏≠‡∏¢‡∏ß‡πà‡∏≠‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°"],
            "‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡∏°‡∏™‡πå‡∏õ‡∏£‡∏∞‡∏ï‡∏π 6 ‡∏ï‡∏∂‡∏Å‡∏ä‡πâ‡∏≤‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤"],
            "Tea Shake": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤"]
        },
        "‡∏ó‡∏≤‡∏á‡πÅ‡∏¢‡∏Å‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤ (‡∏ñ‡∏ô‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏¥‡∏ô‡∏•‡∏µ‡πà‡πÅ‡∏•‡∏ô‡∏î‡πå)": {
            "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß/‡πÇ‡∏•‡∏ï‡∏±‡∏™)": ["‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß (‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏Å‡∏Æ‡∏∞)", "‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß (‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏ñ‡∏≤‡∏î)", "‡∏ã‡∏≠‡∏¢‡πÇ‡∏•‡∏ï‡∏±‡∏™ ‡∏õ‡∏£‡∏∞‡∏ï‡∏π 5", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß (‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡∏≠‡∏¢‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏°‡∏≠)"],
            "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ (‡∏ã‡∏≠‡∏¢‡∏û‡∏£‡∏ß‡∏•‡∏±‡∏¢)": ["‡∏ã‡∏≠‡∏¢‡∏û‡∏£‡∏ß‡∏•‡∏±‡∏¢ ‡∏õ‡∏£‡∏∞‡∏ï‡∏π 5"],
            "‡∏ã‡∏≠‡∏¢‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏°‡∏≠ (‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß)": ["‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏ö‡∏π‡∏Ç‡∏∏‡∏ô‡∏ä‡πâ‡∏≤‡∏á", "‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏°‡∏≠"],
            "‡∏ù‡∏±‡πà‡∏á‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏°‡∏≠ (‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢)": ["‡∏ã‡∏≠‡∏¢‡πÇ‡∏ü‡∏°‡∏à‡πã‡∏≤ (‡∏ù‡∏±‡πà‡∏á‡πÇ‡∏ü‡∏°‡∏à‡πã‡∏≤)", "‡∏ã‡∏≠‡∏¢‡πÇ‡∏ü‡∏°‡∏à‡πã‡∏≤ (‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°)", "‡∏ã‡∏≠‡∏¢‡∏•‡∏≤‡∏ô‡∏≠‡∏µ‡∏™‡∏≤‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏Å‡∏∞‡∏•‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß (‡∏ó‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÄ‡∏î‡∏¥‡∏°)", "‡∏ã‡∏≠‡∏¢‡∏Ñ‡∏≤‡∏£‡πå‡πÅ‡∏Ñ‡∏£‡πå"],
            "‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≤‡∏¢‡πÇ‡∏ö‡∏£‡∏≤‡∏ì": ["‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≤‡∏¢‡πÇ‡∏ö‡∏£‡∏≤‡∏ì"]
        }
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4-5 (‡∏ó‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°)": {
        "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Ñ‡πÇ‡∏£‡∏∞": ["‡∏ã‡∏≠‡∏¢‡∏õ‡∏∞‡∏õ‡πä‡∏≤ 20", "‡∏ã‡∏≠‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏™‡∏á‡∏û‡∏£‡∏´‡∏°‡πÅ‡∏•‡∏ô‡∏î‡πå", "‡∏ó‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏õ‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø"],
        "‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤"]
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4": {
        "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ (‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß/‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô)": {
            "‡∏ã‡∏≠‡∏¢‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß ‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4": ["‡∏ã‡∏≠‡∏¢‡∏ò‡∏¥‡∏î‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)", "‡∏ã‡∏≠‡∏¢‡∏ò‡∏¥‡∏î‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå (‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤)", "‡∏ã‡∏≠‡∏¢‡∏ò‡∏¥‡∏î‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå (‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢)", "‡∏ã‡∏≠‡∏¢ TK Land (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)", "‡∏ã‡∏≠‡∏¢ TK Land (‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤)", "‡∏ã‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4 (‡∏´‡∏≠‡∏ô‡∏£‡∏¥‡∏®‡∏≤)"],
            "‡∏ã‡∏≠‡∏¢‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á‡∏ü‡πâ‡∏≤": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢"],
            "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡∏µ": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤"],
            "‡∏ã‡∏≠‡∏¢‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏≤": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤"],
            "‡∏ã‡∏≠‡∏¢ K Hall Condo": ["‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß)", "‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)", "‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ (‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤)", "‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤ (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)"],
            "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏à‡∏±‡πä‡∏ö": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤"],
            "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô‡∏ä‡πá‡∏≠‡∏õ": ["‡∏ù‡∏±‡πà‡∏á‡∏ñ‡∏ô‡∏ô‡πÉ‡∏´‡∏ç‡πà", "‡∏ù‡∏±‡πà‡∏á ‡∏°‡∏ô."],
            "‡∏ã‡∏≠‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô‡∏ä‡πá‡∏≠‡∏õ": ["‡∏ó‡∏≤‡∏á‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏õ‡∏£‡πâ‡∏≤‡∏ô Pow"]
        },
        "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ß/‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø)": {
            "‡∏ã‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)": [
                "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏±‡∏î‡∏à‡∏±‡∏á", "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ß‡∏ô‡∏¥‡∏î‡∏≤", "‡∏ã‡∏≠‡∏¢‡πÅ‡∏Æ‡∏õ‡∏õ‡∏µ‡πâ‡πÇ‡∏Æ‡∏° (‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤-‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°)", 
                "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤‡∏õ‡∏•‡∏≤‡∏ß‡∏≤‡∏¨ (‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô)", "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤‡∏õ‡∏•‡∏≤‡∏ß‡∏≤‡∏¨ (‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°)",
                "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå/‡πÄ‡∏Ñ‡∏£‡∏õ", "‡∏ã‡∏≠‡∏¢‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ö‡∏∏‡∏ç‡∏ä‡∏π", 
                "‡∏ã‡∏≠‡∏¢‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ó‡∏£‡∏µ‡πÑ‡∏î‡∏°‡∏≠‡∏ô‡∏î‡πå (‡∏ù‡∏±‡πà‡∏á‡∏´‡∏≠)", "‡∏ã‡∏≠‡∏¢‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ó‡∏£‡∏µ‡πÑ‡∏î‡∏°‡∏≠‡∏ô‡∏î‡πå (‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°)",
                "‡∏ã‡∏≠‡∏¢‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ó‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê (‡∏ù‡∏±‡πà‡∏á‡∏´‡∏≠)", "‡∏ã‡∏≠‡∏¢‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ó‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê (‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°)",
                "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á (‡πÄ‡∏≠‡∏ß‡∏≤ ‡πÇ‡∏Æ‡∏°)", "‡∏ñ‡∏ô‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏™‡∏á‡∏û‡∏£‡∏´‡∏°‡πÅ‡∏•‡∏ô‡∏î‡πå"
            ],
            "‡∏ã‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø (‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤)": [
                "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô It's Time", "‡∏ã‡∏≠‡∏¢‡∏°‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏®‡∏ß‡∏£", "‡∏ã‡∏≠‡∏¢‡πÅ‡∏Æ‡∏õ‡∏õ‡∏µ‡πâ‡πÇ‡∏Æ‡∏° (‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢)", 
                "‡∏ã‡∏≠‡∏¢‡πÅ‡∏Æ‡∏õ‡∏õ‡∏µ‡πâ‡πÇ‡∏Æ‡∏° (‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏ù‡∏î)", "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô Pow (‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô)", 
                "‡∏ã‡∏≠‡∏¢‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏ä‡∏£ 5 & Lovely Place"
            ],
            "‡πÇ‡∏ã‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ": ["‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ß", "‡∏ã‡∏≠‡∏¢‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4 (‡∏ñ‡∏ô‡∏ô‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏•‡∏≠‡∏á)"]
        }
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 3": {
        "‡πÅ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô": {
            "‡∏ï‡∏£‡∏á‡πÑ‡∏õ": ["‡πÇ‡∏ã‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏´‡∏±‡∏ß‡πÇ‡∏Ñ‡πâ‡∏á"],
            "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢": ["‡∏ã‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏´‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤"],
            "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤": ["‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏´‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤"]
        }
    }
}

# --- 2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ---
try:
    genai.configure(api_key=st.secrets["API_KEY"])
    model = genai.GenerativeModel('models/gemini-2.5-flash')
except: st.error("AI Config Error")

def get_sheet():
    scope = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    creds = Credentials.from_service_account_info(st.secrets["gcp_service_account"], scopes=scope)
    return gspread.authorize(creds).open_by_key(st.secrets["SHEET_ID"]).get_worksheet(0)

# --- 3. UI ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å ---
st.title("üõµ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡∏°‡∏ô. (Database ‡∏à‡∏£‡∏¥‡∏á)")

location = streamlit_geolocation()
lat, lon = location.get('latitude'), location.get('longitude')

if lat and lon:
    st.subheader("üìç ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà")
    
    # STEP 1: ‡∏õ‡∏£‡∏∞‡∏ï‡∏π
    gate = st.selectbox("1Ô∏è‚É£ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π --"] + list(NU_STRUCTURE.keys()))
    
    if gate != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π --":
        # STEP 2: ‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å
        main_alleys = list(NU_STRUCTURE[gate].keys())
        main_soi = st.selectbox("2Ô∏è‚É£ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å/‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å --"] + main_alleys)
        
        if main_soi != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å --":
            # STEP 3: ‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢
            target = NU_STRUCTURE[gate][main_soi]
            if isinstance(target, dict):
                sub_soi = st.selectbox("3Ô∏è‚É£ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢ --"] + list(target.keys()))
                if sub_soi != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢ --":
                    # STEP 4: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á
                    spot = st.selectbox("4Ô∏è‚É£ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á/‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô:", target[sub_soi])
            else:
                spot = st.selectbox("3Ô∏è‚É£ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á/‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô:", target)
                sub_soi = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢‡πÅ‡∏¢‡∏Å"

            # STEP 5: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
            extra_detail = st.text_input("‚úçÔ∏è ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡∏û‡∏±‡∏Å/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°):")
            
            # ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            full_record = f"{gate} | {main_soi} | {sub_soi} | {spot}"
            if extra_detail: full_record += f" | ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: {extra_detail}"
            
            st.write("---")
            st.info(f"üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏á Sheet: {full_record}")

            if st.button("üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"):
                with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."):
                    sheet = get_sheet()
                    headers = sheet.row_values(1)
                    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    maps_url = f"https://www.google.com/maps?q={lat},{lon}"
                    
                    # ‡∏´‡∏¢‡∏≠‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                    data_row = [""] * len(headers)
                    for i, h in enumerate(headers):
                        h_l = h.lower()
                        if "‡πÄ‡∏ß‡∏•‡∏≤" in h_l: data_row[i] = now
                        elif "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" in h_l or "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" in h_l: data_row[i] = full_record
                        elif "‡∏û‡∏¥‡∏Å‡∏±‡∏î" in h_l or "lat" in h_l: data_row[i] = f"{lat}, {lon}"
                        elif "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á" in h_l: data_row[i] = maps_url
                        elif "ai" in h_l: data_row[i] = model.generate_content(f"‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡πÜ: {full_record}").text
                    
                    sheet.append_row(data_row)
                    st.balloons()
                    st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
else:
    st.warning("üìç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° GPS (‡∏ß‡∏á‡∏Å‡∏•‡∏°) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")

# --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™ 9999 ---
with st.expander("‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™ 9999)"):
    pin = st.text_input("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:", type="password")
    if pin == "9999":
        sheet = get_sheet()
        df = pd.DataFrame(sheet.get_all_records())
        st.dataframe(df)
        row_id = st.number_input("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ (‡∏î‡∏π‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î):", min_value=0, step=1)
        new_val = st.text_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ã‡∏ü‡∏ó‡∏±‡∏ö:")
        if st.button("üíæ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"):
            # ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 4 ‡∏Ñ‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ)
            sheet.update_cell(row_id + 2, 4, new_val)
            st.success("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
