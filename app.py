import streamlit as st
import gspread
import pandas as pd
from google.oauth2.service_account import Credentials
from streamlit_geolocation import streamlit_geolocation
from datetime import datetime
import pydeck as pdk

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ---
st.set_page_config(page_title="NU Delivery: Pro Map", layout="wide")

def get_sheets():
    try:
        scope = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
        creds = Credentials.from_service_account_info(st.secrets["gcp_service_account"], scopes=scope)
        return gspread.authorize(creds).open_by_key(st.secrets["SHEET_ID"])
    except: return None

def load_data_robust(sheet_name):
    sh = get_sheets()
    if not sh: return pd.DataFrame()
    try:
        ws = sh.worksheet(sheet_name)
        all_values = ws.get_all_values()
        if len(all_values) > 1:
            headers = [str(h).strip().lower() for h in all_values[0]]
            df = pd.DataFrame(all_values[1:], columns=headers)
            df['lat'] = pd.to_numeric(df['lat'], errors='coerce')
            df['lon'] = pd.to_numeric(df['lon'], errors='coerce')
            return df.dropna(subset=['lat', 'lon'])
        return pd.DataFrame()
    except: return pd.DataFrame()

# --- 2. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å ---
st.title("üõµ NU Delivery Pro (Map Fix)")

tab1, tab2, tab3 = st.tabs(["üìå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô", "‚öôÔ∏è ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏ì‡∏≤‡πÄ‡∏Ç‡∏ï"])

# --- TAB 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á GPS) ---
with tab1:
    st.subheader("üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà")
    
    # ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î
    st.info("üí° ‡∏´‡∏≤‡∏Å‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î Tab ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ https://")
    
    location = streamlit_geolocation()
    lat, lon = location.get('latitude'), location.get('longitude')
    
    if lat and lon:
        st.success(f"‚úÖ ‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {lat}, {lon}")
    else:
        st.warning("üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á... (‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)")

    p_name = st.text_input("üè† ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£")
    note = st.text_area("üóíÔ∏è ‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°")
    
    # ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û 3 ‡∏£‡∏π‡∏õ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)
    c1, c2, c3 = st.columns(3)
    img1 = c1.file_uploader("‡∏£‡∏π‡∏õ 1", type=['jpg','png'])
    img2 = c2.file_uploader("‡∏£‡∏π‡∏õ 2", type=['jpg','png'])
    img3 = c3.file_uploader("‡∏£‡∏π‡∏õ 3", type=['jpg','png'])

    if st.button("üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏µ‡∏ï", use_container_width=True, type="primary"):
        if lat and p_name:
            ws = get_sheets().worksheet("Sheet1")
            imgs = ["Yes" if i else "No" for i in [img1, img2, img3]]
            new_row = [datetime.now().strftime("%Y-%m-%d %H:%M"), lat, lon, p_name, note, "‡∏£‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"] + imgs + [""]*7
            ws.insert_row(new_row, index=2)
            st.balloons()
            st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
        else: st.error("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î")

# --- TAB 2: ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏£‡∏´‡∏±‡∏™ 9999) ---
with tab2:
    pwd = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", type="password")
    if pwd == "9999":
        st.write("üîß ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin Only)")
        # ... (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°) ...
    elif pwd != "":
        st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")

# --- TAB 3: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö Interactive ---
with tab3:
    st.subheader("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏≠‡∏≤‡∏ì‡∏≤‡πÄ‡∏Ç‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    all_df = load_data_robust("Sheet1")
    
    if not all_df.empty:
        # 1. ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏ì‡∏≤‡πÄ‡∏Ç‡∏ï‡∏û‡∏£‡πâ‡∏≠‡∏° Tooltip
        st.write("üåç **‡∏≠‡∏≤‡∏ì‡∏≤‡πÄ‡∏Ç‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ä‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)**")
        
        # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß (‡πÉ‡∏ä‡πâ Carto Light)
        view_state = pdk.ViewState(
            latitude=all_df['lat'].mean(), 
            longitude=all_df['lon'].mean(), 
            zoom=14, pitch=0
        )
        
        layer = pdk.Layer(
            "ScatterplotLayer",
            all_df,
            get_position='[lon, lat]',
            get_color='[255, 75, 75, 180]',
            get_radius=30,
            pickable=True, # ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡πâ‡πÑ‡∏î‡πâ
        )
        
        # ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        st.pydeck_chart(pdk.Deck(
            map_style='mapbox://styles/mapbox/light-v10', # ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô None ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏ß
            initial_view_state=view_state,
            layers=[layer],
            tooltip={
                "html": "<b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</b> {place_name} <br/> <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> {note} <br/> <b>‡πÇ‡∏ã‡∏ô:</b> {gate}",
                "style": {"backgroundColor": "steelblue", "color": "white"}
            }
        ))
        
        

        # 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°
        st.divider()
        query = st.text_input("üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏π‡∏°‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏à‡∏≥‡∏•‡∏≠‡∏á:")
        if query:
            res = all_df[all_df.apply(lambda r: query.lower() in str(r.values).lower(), axis=1)]
            for idx, row in res.iterrows():
                with st.expander(f"üìç {row['place_name']} - ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°"):
                    c_info, c_map = st.columns(2)
                    with c_info:
                        st.write(f"**‡∏õ‡∏£‡∏∞‡∏ï‡∏π:** {row.get('gate', '-')}")
                        st.write(f"**‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:** {row['note']}")
                        st.link_button("üöó ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ Google Maps", f"https://www.google.com/maps?q={row['lat']},{row['lon']}")
                    with c_map:
                        # ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏π‡∏°‡∏£‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡πÅ‡∏ö‡∏ö‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°
                        st.pydeck_chart(pdk.Deck(
                            map_style='mapbox://styles/mapbox/satellite-v9',
                            initial_view_state=pdk.ViewState(latitude=row['lat'], longitude=row['lon'], zoom=18),
                            layers=[pdk.Layer("ScatterplotLayer", pd.DataFrame([row]), get_position='[lon, lat]', get_color='[255,0,0]', get_radius=10)]
                        ))
    else:
        st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")
