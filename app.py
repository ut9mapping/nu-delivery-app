import streamlit as st
import google.generativeai as genai
import gspread
import pandas as pd
from google.oauth2.service_account import Credentials
from streamlit_geolocation import streamlit_geolocation
from datetime import datetime

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
st.set_page_config(page_title="NU Smart Quiz Delivery", page_icon="üõµ", layout="wide")
st.title("üõµ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á ‡∏°‡∏ô. (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≠‡∏ö)")

# --- 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤) ---
NU_OPTIONS = {
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 1": {
        "‡πÇ‡∏ã‡∏ô": ["‡∏ã‡∏≠‡∏¢‡∏ï‡∏¥‡∏î‡∏£‡∏±‡πâ‡∏ß", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á (‡∏´‡∏≠‡∏ô‡∏±‡∏î‡∏î‡∏≤/‡∏ó‡∏≠‡∏£‡∏±‡∏™)", "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏ù‡πâ‡∏≤‡∏¢‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß"],
        "‡∏ù‡∏±‡πà‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢", "‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ñ‡∏ô‡∏ô"]
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 3": {
        "‡πÇ‡∏ã‡∏ô": ["‡πÇ‡∏ã‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏´‡∏±‡∏ß‡πÇ‡∏Ñ‡πâ‡∏á", "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏∞‡∏û‡∏≤‡∏ô)", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ (‡πÄ‡∏•‡∏¢‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤)"],
        "‡∏ù‡∏±‡πà‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢"]
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4": {
        "‡πÇ‡∏ã‡∏ô": [
            "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡∏ã‡∏≠‡∏¢‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß (‡∏ò‡∏¥‡∏î‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå/TK Land)", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡∏ã‡∏≠‡∏¢‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á‡∏ü‡πâ‡∏≤/‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡∏µ", 
            "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡∏ã‡∏≠‡∏¢‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏≤/K Hall", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô/‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô‡∏ä‡πá‡∏≠‡∏õ",
            "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ß", "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ã‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø", "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ã‡∏≠‡∏¢‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß",
            "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏á‡∏û‡∏£‡∏´‡∏°‡πÅ‡∏•‡∏ô‡∏î‡πå 2 (‡∏õ‡∏•‡∏≤‡∏ß‡∏≤‡∏¨/‡∏ö‡∏∏‡∏ç‡∏ä‡∏π/‡∏ó‡∏£‡∏µ‡πÑ‡∏î‡∏°‡∏≠‡∏ô‡∏î‡πå)"
        ],
        "‡∏ù‡∏±‡πà‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á (‡πÄ‡∏≠‡∏ß‡∏≤‡πÇ‡∏Æ‡∏°)"]
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 5 ‡∏ñ‡∏∂‡∏á 6": {
        "‡πÇ‡∏ã‡∏ô": ["‡∏ã‡∏≠‡∏¢ NU Plaza", "‡∏ã‡∏≠‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏ä‡∏£‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î", "‡∏ã‡∏≠‡∏¢‡πÇ‡∏•‡∏Å‡∏µ‡∏¢‡πå", "‡∏ã‡∏≠‡∏¢‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß‡∏õ‡∏£‡∏∞‡∏ï‡∏π 6", "‡∏ñ‡∏ô‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏¥‡∏ô‡∏•‡∏µ‡πà‡πÅ‡∏•‡∏ô‡∏î‡πå"],
        "‡∏ù‡∏±‡πà‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢"]
    }
}

# --- 2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ---
try:
    genai.configure(api_key=st.secrets["API_KEY"])
    model = genai.GenerativeModel('models/gemini-2.5-flash')
except: st.error("Gemini Error")

def get_sheet():
    scope = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    creds = Credentials.from_service_account_info(st.secrets["gcp_service_account"], scopes=scope)
    return gspread.authorize(creds).open_by_key(st.secrets["SHEET_ID"]).get_worksheet(0)

# --- 3. UI ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
tab1, tab2, tab3 = st.tabs(["üìù ‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î", "üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ AI", "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (9999)"])

with tab1:
    st.subheader("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î")
    
    location = streamlit_geolocation()
    lat, lon = location.get('latitude'), location.get('longitude')

    if lat and lon:
        # --- ‡∏Ç‡πâ‡∏≠ 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π ---
        gate = st.selectbox("1Ô∏è‚É£ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π:", ["-- ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + list(NU_OPTIONS.keys()))
        
        if gate != "-- ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --":
            # --- ‡∏Ç‡πâ‡∏≠ 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢/‡πÇ‡∏ã‡∏ô ---
            zone = st.selectbox(f"2Ô∏è‚É£ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡πÉ‡∏ô {gate}:", ["-- ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + NU_OPTIONS[gate]["‡πÇ‡∏ã‡∏ô"])
            
            if zone != "-- ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --":
                # --- ‡∏Ç‡πâ‡∏≠ 3: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á ---
                side = st.radio(f"3Ô∏è‚É£ ‡∏≠‡∏¢‡∏π‡πà‡∏ù‡∏±‡πà‡∏á‡πÑ‡∏´‡∏ô‡∏Ç‡∏≠‡∏á {zone}?", NU_OPTIONS[gate]["‡∏ù‡∏±‡πà‡∏á"])
                
                # --- ‡∏Ç‡πâ‡∏≠ 4: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ---
                extra = st.text_input("4Ô∏è‚É£ ‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠/‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):")
                
                full_note = f"{gate} | {zone} | {side} | ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: {extra}"
                
                st.write("---")
                st.write("**‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:**")
                st.code(full_note)

                if st.button("üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"):
                    with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets...'):
                        sheet = get_sheet()
                        headers = sheet.row_values(1)
                        now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                        maps_url = f"https://www.google.com/maps?q={lat},{lon}"
                        
                        # AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á
                        ai_sum = model.generate_content(f"‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà ‡∏°‡∏ô.: {full_note}").text
                        
                        # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                        data_map = {
                            "‡πÄ‡∏ß‡∏•‡∏≤": now, "‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î": lat, "‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î": lon,
                            "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å": full_note, "‡∏™‡∏£‡∏∏‡∏õ": ai_sum, "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á": maps_url
                        }
                        
                        # ‡∏´‡∏¢‡∏≠‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        new_row = [""] * len(headers)
                        for i, h in enumerate(headers):
                            for key in data_map:
                                if key in h: new_row[i] = data_map[key]
                        
                        sheet.append_row(new_row)
                        st.balloons()
                        st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
    else:
        st.warning("‚ö†Ô∏è ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° GPS (‡∏ß‡∏á‡∏Å‡∏•‡∏°) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î")

# --- Tab 2 & 3 ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ---
with tab2:
    st.header("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢ AI")
    q = st.text_input("‡∏ñ‡∏≤‡∏° AI ‡πÄ‡∏ä‡πà‡∏ô '‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÇ‡∏Å‡∏Æ‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ù‡∏±‡πà‡∏á‡πÑ‡∏´‡∏ô?'")
    if st.button("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"):
        sheet = get_sheet()
        df = pd.DataFrame(sheet.get_all_records())
        ans = model.generate_content(f"‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ: {df.to_string()} \n‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {q}").text
        st.markdown(ans)

with tab3:
    st.header("‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (PIN: 9999)")
    pin = st.text_input("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ PIN:", type="password")
    if pin == "9999":
        sheet = get_sheet()
        df = pd.DataFrame(sheet.get_all_records())
        st.dataframe(df)
        row_idx = st.number_input("‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ (Index):", min_value=0, step=1)
        new_val = st.text_input("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà:")
        if st.button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"):
            # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 4)
            sheet.update_cell(row_idx + 2, 4, new_val)
            st.success("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
