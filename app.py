import streamlit as st
import gspread
import pandas as pd
from google.oauth2.service_account import Credentials
from streamlit_geolocation import streamlit_geolocation
from datetime import datetime
import google.generativeai as genai

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
st.set_page_config(page_title="NU Smart Delivery Database", page_icon="üõµ", layout="wide")

# --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ---
def get_sheets():
    scope = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Secrets ‡∏Ç‡∏≠‡∏á Streamlit
    creds = Credentials.from_service_account_info(st.secrets["gcp_service_account"], scopes=scope)
    client = gspread.authorize(creds)
    return client.open_by_key(st.secrets["SHEET_ID"])

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡∏≠‡∏¢ (Mapping) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ Error ---
def load_mapping_df():
    try:
        sh = get_sheets()
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô Mapping ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        try:
            sheet = sh.worksheet("Mapping")
        except gspread.exceptions.WorksheetNotFound:
            # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            sheet = sh.add_worksheet(title="Mapping", rows="100", cols="10")
            sheet.append_row(["‡∏õ‡∏£‡∏∞‡∏ï‡∏π", "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á"])
            return pd.DataFrame(columns=["‡∏õ‡∏£‡∏∞‡∏ï‡∏π", "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á"])

        data = sheet.get_all_records()
        if not data:
            return pd.DataFrame(columns=["‡∏õ‡∏£‡∏∞‡∏ï‡∏π", "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á"])
        
        df = pd.DataFrame(data)
        
        # [‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 2] ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        df.columns = [str(c).strip() for c in df.columns]
        df = df.map(lambda x: str(x).strip() if isinstance(x, str) else x)
        
        return df
    except Exception as e:
        st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {e}")
        return pd.DataFrame(columns=["‡∏õ‡∏£‡∏∞‡∏ï‡∏π", "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á"])

# --- 3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á (Conflict Checker) ---
def validate_structure(df, new_gate, new_soi, new_detail):
    # ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡∏ã‡∏≠‡∏¢‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    existing = df[df['‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å'] == new_soi]['‡∏õ‡∏£‡∏∞‡∏ï‡∏π'].unique()
    if len(existing) > 0 and existing[0] != new_gate:
        return f"‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á: ‡∏ã‡∏≠‡∏¢ '{new_soi}' ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà '{existing[0]}' ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô '{new_gate}' ‡πÑ‡∏î‡πâ"
    
    # ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
    dup = df[(df['‡∏õ‡∏£‡∏∞‡∏ï‡∏π'] == new_gate) & (df['‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å'] == new_soi) & (df['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á'] == new_detail)]
    if not dup.empty:
        return "‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"
    
    return None

# --- 4. ‡∏´‡∏ô‡πâ‡∏≤ UI ‡∏´‡∏•‡∏±‡∏Å ---
st.title("üìç ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡∏≠‡∏¢ ‡∏°‡∏ô.")

# ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
mapping_df = load_mapping_df()

tab1, tab2 = st.tabs(["üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á", "‚öôÔ∏è ‡πÇ‡∏´‡∏°‡∏î Admin (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡∏≠‡∏¢)"])

# --- TAB 1: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á ---
with tab1:
    location = streamlit_geolocation()
    lat, lon = location.get('latitude'), location.get('longitude')

    if lat and lon:
        st.subheader("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á")
        col1, col2, col3 = st.columns(3)
        
        with col1:
            gate_list = sorted(mapping_df['‡∏õ‡∏£‡∏∞‡∏ï‡∏π'].unique().tolist())
            gate = st.selectbox("1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + gate_list)
        
        with col2:
            if gate != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --":
                sois = sorted(mapping_df[mapping_df['‡∏õ‡∏£‡∏∞‡∏ï‡∏π'] == gate]['‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å'].unique().tolist())
                main_soi = st.selectbox("2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + sois)
            else: main_soi = "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"
            
        with col3:
            if main_soi != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --":
                spots = mapping_df[(mapping_df['‡∏õ‡∏£‡∏∞‡∏ï‡∏π'] == gate) & (mapping_df['‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å'] == main_soi)]['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á'].tolist()
                spot = st.selectbox("3. ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á/‡∏ù‡∏±‡πà‡∏á/‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + spots)
            else: spot = "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"

        extra = st.text_input("‚úçÔ∏è ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á / ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô / ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡∏û‡∏±‡∏Å (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°):")

        if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Google Sheets"):
            if gate != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --" and main_soi != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --" and spot != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --":
                with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."):
                    sh = get_sheets()
                    # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Sheet1)
                    log_sheet = sh.get_worksheet(0)
                    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    full_info = f"{gate} | {main_soi} | {spot} | {extra}"
                    maps_url = f"https://www.google.com/maps?q={lat},{lon}"
                    
                    log_sheet.append_row([now, full_info, lat, lon, maps_url])
                    st.balloons()
                    st.success(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {full_info}")
            else:
                st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô")
    else:
        st.warning("üìç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° GPS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")

# --- TAB 2: ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Database) ---
with tab2:
    st.header("‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡∏≠‡∏¢ (Admin Only)")
    pin = st.text_input("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", type="password")
    
    if pin == "9999":
        st.info("üí° ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ï‡∏π ‡∏ã‡∏≠‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ")
        
        # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        with st.expander("üìä ‡∏î‡∏π‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡∏≠‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"):
            st.dataframe(mapping_df, use_container_width=True)

        st.divider()

        # ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ß‡∏Å)
        st.subheader("‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á Database")
        c1, c2, c3 = st.columns(3)
        
        with c1:
            # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÉ‡∏´‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ
            gate_options = ["‡∏õ‡∏£‡∏∞‡∏ï‡∏π 1", "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 3", "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4", "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 5 ‡∏ñ‡∏∂‡∏á 6", "-- ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÉ‡∏´‡∏°‡πà --"]
            add_gate = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π:", gate_options)
            if add_gate == "-- ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÉ‡∏´‡∏°‡πà --":
                add_gate = st.text_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÉ‡∏´‡∏°‡πà:")
        
        with c2:
            # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡∏≠‡∏¢‡πÉ‡∏´‡∏°‡πà
            if add_gate and add_gate != "-- ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÉ‡∏´‡∏°‡πà --":
                existing_sois = mapping_df[mapping_df['‡∏õ‡∏£‡∏∞‡∏ï‡∏π'] == add_gate]['‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å'].unique().tolist()
                add_soi = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏¢‡πà‡∏≠‡∏¢) ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà:", ["-- ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡∏≠‡∏¢‡πÉ‡∏´‡∏°‡πà --"] + existing_sois)
                if add_soi == "-- ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡∏≠‡∏¢‡πÉ‡∏´‡∏°‡πà --":
                    add_soi = st.text_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà:")
            else:
                add_soi = st.text_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà:")

        with c3:
            add_detail = st.text_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏ù‡∏±‡πà‡∏á/‡∏à‡∏∏‡∏î‡∏¢‡πà‡∏≠‡∏¢:")

        if st.button("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ß‡∏Å)"):
            if add_gate and add_soi and add_detail:
                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                error = validate_structure(mapping_df, add_gate, add_soi, add_detail)
                if error:
                    st.error(error)
                else:
                    with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Google Sheets..."):
                        sh = get_sheets()
                        sh.worksheet("Mapping").append_row([add_gate, add_soi, add_detail])
                        st.cache_data.clear() # ‡∏•‡πâ‡∏≤‡∏á Cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        st.success(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å '{add_soi} > {add_detail}' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
                        st.rerun()
            else:
                st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á")

        # ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        with st.expander("üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î"):
            row_idx = st.number_input("‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö (‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô):", min_value=1, step=1)
            if st.button("üî• ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß"):
                sh = get_sheets()
                sh.worksheet("Mapping").delete_rows(row_idx + 1) # +1 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ Header
                st.cache_data.clear()
                st.success("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
                st.rerun()
    elif pin != "":
        st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
    else:
        st.write("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ 9999 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç")
