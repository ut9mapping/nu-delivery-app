import streamlit as st
import google.generativeai as genai
import gspread
import pandas as pd
from google.oauth2.service_account import Credentials
from streamlit_geolocation import streamlit_geolocation
from datetime import datetime

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
st.set_page_config(page_title="NU Professional Navigator", page_icon="üìç", layout="wide")

# --- 1. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà Mapping ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (Accurate Version) ---
NU_DB = {
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 1 (‡∏ñ‡∏ô‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏°.)": {
        "‡πÇ‡∏ã‡∏ô‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏°.": {
            "‡∏ã‡∏≠‡∏¢‡∏ï‡∏¥‡∏î‡∏£‡∏±‡πâ‡∏ß": ["‡∏°‡∏µ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏ù‡∏±‡πà‡∏á‡∏£‡∏±‡πâ‡∏ß)"],
            "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ô‡∏±‡∏î‡∏î‡∏≤", "‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏≠‡∏£‡∏±‡∏™‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞"],
            "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏ù‡πâ‡∏≤‡∏¢‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß": ["‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏ù‡πâ‡∏≤‡∏¢‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß", "‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏ù‡πâ‡∏≤‡∏¢"]
        }
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 5 ‡∏ñ‡∏∂‡∏á 6": {
        "‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏ó‡∏≤‡∏á‡πÅ‡∏¢‡∏Å (‡∏à‡∏≤‡∏Å ‡∏õ.5)": ["‡∏ã‡∏≠‡∏¢ NU Plaza", "‡∏ã‡∏≠‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏ä‡∏£‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î", "‡∏ã‡∏≠‡∏¢‡πÇ‡∏•‡∏Å‡∏µ‡∏¢‡πå (‡∏ù‡∏±‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏∑‡πà‡∏ô/‡∏õ‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏±‡∏ç)"],
        "‡∏ó‡∏≤‡∏á‡πÅ‡∏¢‡∏Å‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ (‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß ‡∏õ.6)": ["NU1", "NU2", "NU3", "Pyland1", "Pyland2", "‡∏ß‡πà‡∏≠‡∏á", "‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡∏°‡∏™‡πå‡∏ï‡∏∂‡∏Å‡∏ä‡πâ‡∏≤‡∏á", "Tea Shake"],
        "‡∏ó‡∏≤‡∏á‡πÅ‡∏¢‡∏Å‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤ (‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏¥‡∏ô‡∏•‡∏µ‡πà‡πÅ‡∏•‡∏ô‡∏î‡πå)": {
            "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß/‡πÇ‡∏•‡∏ï‡∏±‡∏™ ‡∏õ.5)": ["‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß (‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏Å‡∏Æ‡∏∞/‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏ñ‡∏≤‡∏î)", "‡∏ã‡∏≠‡∏¢‡πÇ‡∏•‡∏ï‡∏±‡∏™ ‡∏õ‡∏£‡∏∞‡∏ï‡∏π 5", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß (‡∏ã‡∏≠‡∏¢‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏°‡∏≠)"],
            "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ (‡∏ã‡∏≠‡∏¢‡∏û‡∏£‡∏ß‡∏•‡∏±‡∏¢ ‡∏õ.5)": ["‡∏ã‡∏≠‡∏¢‡∏û‡∏£‡∏ß‡∏•‡∏±‡∏¢ ‡∏õ‡∏£‡∏∞‡∏ï‡∏π 5"]
        },
        "‡πÇ‡∏ã‡∏ô‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏°‡∏≠/‡πÇ‡∏ü‡∏°‡∏à‡πã‡∏≤ (‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß)": {
            "‡∏ù‡∏±‡πà‡∏á‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏°‡∏≠": ["‡∏ã‡∏≠‡∏¢‡πÇ‡∏ü‡∏°‡∏à‡πã‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏•‡∏≤‡∏ô‡∏≠‡∏µ‡∏™‡∏≤‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏Å‡∏∞‡∏•‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß(‡∏ó‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°)", "‡∏ã‡∏≠‡∏¢‡∏Ñ‡∏≤‡∏£‡πå‡πÅ‡∏Ñ‡∏£‡πå"],
            "‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≤‡∏¢‡πÇ‡∏ö‡∏£‡∏≤‡∏ì": ["‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≤‡∏¢‡πÇ‡∏ö‡∏£‡∏≤‡∏ì"]
        }
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4-5 (‡∏ó‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°)": {
        "‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å": ["‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Ñ‡πÇ‡∏£‡∏∞", "‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô ‡∏õ.4 ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô ‡∏õ.4 ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤"],
        "‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡πÇ‡∏£‡∏∞": ["‡∏ã‡∏≠‡∏¢‡∏õ‡∏∞‡∏õ‡πä‡∏≤ 20", "‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏™‡∏á‡∏û‡∏£‡∏´‡∏°‡πÅ‡∏•‡∏ô‡∏î‡πå", "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏õ‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø"]
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4": {
        "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ (‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß/‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô)": {
            "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å": ["‡∏ã‡∏≠‡∏¢‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß ‡∏õ.4", "‡∏ã‡∏≠‡∏¢‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á‡∏ü‡πâ‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡∏µ", "‡∏ã‡∏≠‡∏¢‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏≤", "‡∏ã‡∏≠‡∏¢ K Hall Condo", "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏à‡∏±‡πä‡∏ö", "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô‡∏ä‡πá‡∏≠‡∏õ", "‡∏ã‡∏≠‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô‡∏ä‡πá‡∏≠‡∏õ"],
            "‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß ‡∏õ.4": ["‡∏ã‡∏≠‡∏¢‡∏ò‡∏¥‡∏î‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå", "‡∏ã‡∏≠‡∏¢ TK Land", "‡∏ã‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°", "‡πÇ‡∏ã‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ô‡∏£‡∏¥‡∏®‡∏≤"]
        },
        "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ß/‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø)": {
            "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å": ["‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ß", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø", "‡∏ã‡∏≠‡∏¢‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß", "‡∏ñ‡∏ô‡∏ô‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏•‡∏≠‡∏á (‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏∞‡∏û‡∏≤‡∏ô)"],
            "‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)": ["‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏±‡∏î‡∏à‡∏±‡∏á", "‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ß‡∏ô‡∏¥‡∏î‡∏≤", "‡πÅ‡∏Æ‡∏õ‡∏õ‡∏µ‡πâ‡πÇ‡∏Æ‡∏° (‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤-‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°)", "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏á‡∏û‡∏£‡∏´‡∏°‡πÅ‡∏•‡∏ô‡∏î‡πå 2 (‡∏õ‡∏•‡∏≤‡∏ß‡∏≤‡∏¨/‡πÄ‡∏Ñ‡∏£‡∏õ/‡∏ö‡∏∏‡∏ç‡∏ä‡∏π/‡∏ó‡∏£‡∏µ‡πÑ‡∏î‡∏°‡∏≠‡∏ô‡∏î‡πå/‡∏ó‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê)"],
            "‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø (‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤)": ["‡∏£‡πâ‡∏≤‡∏ô It's Time", "‡∏°‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏®‡∏ß‡∏£", "‡πÅ‡∏Æ‡∏õ‡∏õ‡∏µ‡πâ‡πÇ‡∏Æ‡∏° (‡∏™‡∏ô‡∏á.‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢)", "‡πÅ‡∏Æ‡∏õ‡∏õ‡∏µ‡πâ‡πÇ‡∏Æ‡∏° (‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏ù‡∏î)", "‡∏£‡πâ‡∏≤‡∏ô Pow (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô)", "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏ä‡∏£ 5 / Lovely Place"]
        }
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 3": {
        "‡∏´‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏∞‡∏û‡∏≤‡∏ô": ["‡∏ï‡∏£‡∏á‡πÑ‡∏õ (‡πÇ‡∏ã‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏´‡∏±‡∏ß‡πÇ‡∏Ñ‡πâ‡∏á)", "‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ (‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡∏´‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤)", "‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤ (‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡∏´‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤)"]
    }
}

# --- 2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ---
try:
    genai.configure(api_key=st.secrets["API_KEY"])
    model = genai.GenerativeModel('models/gemini-2.5-flash')
except: st.error("AI Connection Error")

def get_sheet():
    scope = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    creds = Credentials.from_service_account_info(st.secrets["gcp_service_account"], scopes=scope)
    return gspread.authorize(creds).open_by_key(st.secrets["SHEET_ID"]).get_worksheet(0)

# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ---
def save_data(data_dict):
    sheet = get_sheet()
    headers = sheet.row_values(1)
    new_row = [""] * len(headers)
    for i, h in enumerate(headers):
        h_l = h.lower()
        if "‡πÄ‡∏ß‡∏•‡∏≤" in h_l: new_row[i] = data_dict['time']
        elif "‡∏û‡∏¥‡∏Å‡∏±‡∏î" in h_l or "lat" in h_l: new_row[i] = f"{data_dict['lat']}, {data_dict['lon']}"
        elif "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" in h_l or "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" in h_l: new_row[i] = data_dict['full_loc']
        elif "‡∏ù‡∏±‡πà‡∏á" in h_l: new_row[i] = data_dict['side']
        elif "ai" in h_l: new_row[i] = data_dict['summary']
        elif "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á" in h_l: new_row[i] = data_dict['url']
    sheet.append_row(new_row)

# --- 4. ‡∏´‡∏ô‡πâ‡∏≤ UI ‡∏´‡∏•‡∏±‡∏Å ---
st.title("üõµ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡∏°‡∏ô. (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á)")

location = streamlit_geolocation()
lat, lon = location.get('latitude'), location.get('longitude')

if lat and lon:
    # --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (Dynamic Quiz) ---
    st.subheader("üìç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á")
    
    # ‡∏Ç‡πâ‡∏≠ 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π
    gate = st.selectbox("1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + list(NU_DB.keys()))
    
    if gate != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --":
        # ‡∏Ç‡πâ‡∏≠ 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á/‡πÇ‡∏ã‡∏ô
        zone_keys = list(NU_DB[gate].keys())
        zone = st.selectbox("2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á/‡πÅ‡∏¢‡∏Å:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + zone_keys)
        
        if zone != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --":
            # ‡∏Ç‡πâ‡∏≠ 3: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢ (Handling Nested Dicts)
            target = NU_DB[gate][zone]
            if isinstance(target, dict):
                sub_zone = st.selectbox("3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + list(target.keys()))
                if sub_zone != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --":
                    soi = st.selectbox("4. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á:", target[sub_zone])
            else:
                soi = st.selectbox("3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢/‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á:", target)
            
            # ‡∏Ç‡πâ‡∏≠ 4: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
            st.write("---")
            side = st.radio("‚ÜïÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:", ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ñ‡∏ô‡∏ô", "‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ô)"])
            
            note = st.text_input("‚úçÔ∏è ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á/‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô):")
            
            full_loc = f"{gate} > {zone} > {soi}"
            st.success(f"‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: {full_loc} | {side} | {note}")

            if st.button("üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå"):
                with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."):
                    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    maps_url = f"https://www.google.com/maps?q={lat},{lon}"
                    ai_summary = model.generate_content(f"‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á: {full_loc} ‡∏ù‡∏±‡πà‡∏á {side} ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ {note}").text
                    
                    save_data({
                        'time': now, 'lat': lat, 'lon': lon,
                        'full_loc': full_loc, 'side': side,
                        'summary': ai_summary, 'url': maps_url
                    })
                    st.balloons()
                    st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")
else:
    st.warning("‚ö†Ô∏è ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° GPS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö")

# --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (PIN 9999) ---
with st.expander("‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏£‡∏´‡∏±‡∏™ 9999)"):
    pin = st.text_input("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:", type="password")
    if pin == "9999":
        sheet = get_sheet()
        df = pd.DataFrame(sheet.get_all_records())
        st.dataframe(df)
        row_to_edit = st.number_input("‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ (Index):", min_value=0, step=1)
        new_val = st.text_input("‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:")
        if st.button("üíæ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ã‡∏ü‡∏ó‡∏±‡∏ö"):
            sheet.update_cell(row_to_edit + 2, 4, new_val) # ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 4 ‡∏Ñ‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            st.success("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß")
