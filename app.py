import streamlit as st
import google.generativeai as genai
import gspread
import pandas as pd
from google.oauth2.service_account import Credentials
from streamlit_geolocation import streamlit_geolocation
from datetime import datetime

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
st.set_page_config(page_title="NU Accurate Mapping", page_icon="üõµ", layout="wide")

# --- 1. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ (Tree Structure) ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á ---
NU_MAP = {
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 1": {
        "‡∏ñ‡∏ô‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏°.": ["‡∏ã‡∏≠‡∏¢‡∏ï‡∏¥‡∏î‡∏£‡∏±‡πâ‡∏ß (‡∏°‡∏µ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á (‡∏´‡∏≠‡∏ô‡∏±‡∏î‡∏î‡∏≤/‡∏ó‡∏≠‡∏£‡∏±‡∏™)", "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏ù‡πâ‡∏≤‡∏¢‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß"],
        "‡∏ù‡∏±‡πà‡∏á/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô/‡∏´‡∏≠‡∏û‡∏±‡∏Å", "‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°", "‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ñ‡∏ô‡∏ô", "‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢"]
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 3": {
        "‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏∞‡∏û‡∏≤‡∏ô": ["‡∏™‡∏µ‡πà‡πÅ‡∏¢‡∏Å - ‡∏ï‡∏£‡∏á‡πÑ‡∏õ (‡πÇ‡∏ã‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏´‡∏±‡∏ß‡πÇ‡∏Ñ‡πâ‡∏á)", "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏´‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤)", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ (‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏´‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤)"],
        "‡∏ù‡∏±‡πà‡∏á/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢"]
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4": {
        "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ (‡πÇ‡∏ã‡∏ô‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß/‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô)": [
            "‡∏ã‡∏≠‡∏¢‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß ‡∏õ.4 (‡∏ò‡∏¥‡∏î‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå/TK Land/‡∏ã‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°)", "‡∏ã‡∏≠‡∏¢‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á‡∏ü‡πâ‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡∏µ", 
            "‡∏ã‡∏≠‡∏¢‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏≤", "‡∏ã‡∏≠‡∏¢ K Hall Condo", "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏û‡∏µ‡πà‡∏à‡∏±‡πä‡∏ö", 
            "‡∏ã‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô‡∏ä‡πá‡∏≠‡∏õ", "‡∏ã‡∏≠‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô‡∏ä‡πá‡∏≠‡∏õ"
        ],
        "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ß)": ["‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ß", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø", "‡∏ã‡∏≠‡∏¢‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß", "‡∏ñ‡∏ô‡∏ô‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏•‡∏≠‡∏á (‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡∏î‡∏¥‡∏ô)"],
        "‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø/‡πÅ‡∏™‡∏á‡∏û‡∏£‡∏´‡∏° 2": [
            "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏±‡∏î‡∏à‡∏±‡∏á/‡∏ß‡∏ô‡∏¥‡∏î‡∏≤", "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡πÅ‡∏Æ‡∏õ‡∏õ‡∏µ‡πâ‡πÇ‡∏Æ‡∏°/‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°", "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ã‡∏≠‡∏¢‡∏õ‡∏•‡∏≤‡∏ß‡∏≤‡∏¨/‡πÄ‡∏Ñ‡∏£‡∏õ/‡∏ö‡∏∏‡∏ç‡∏ä‡∏π",
            "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏´‡∏≠‡∏ó‡∏£‡∏µ‡πÑ‡∏î‡∏°‡∏≠‡∏ô‡∏î‡πå/‡∏ó‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: It's Time/‡∏°‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏®‡∏ß‡∏£", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡πÅ‡∏Æ‡∏õ‡∏õ‡∏µ‡πâ‡πÇ‡∏Æ‡∏° (‡∏Å‡∏°./‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏ù‡∏î)",
            "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡∏£‡πâ‡∏≤‡∏ô Pow (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ß‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô)", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏ä‡∏£ 5/Lovely Place"
        ],
        "‡∏ù‡∏±‡πà‡∏á/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤", "‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢", "‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á (‡πÄ‡∏≠‡∏ß‡∏≤‡πÇ‡∏Æ‡∏°)", "‡∏ñ‡∏ô‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏™‡∏á‡∏û‡∏£‡∏´‡∏°‡πÅ‡∏•‡∏ô‡∏î‡πå"]
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4-5 (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠)": {
        "‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á": ["‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Ñ‡πÇ‡∏£‡∏∞", "‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô ‡∏õ.4 (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)", "‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô ‡∏õ.4 (‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤)"],
        "‡∏ã‡∏≠‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°": ["‡∏ã‡∏≠‡∏¢‡∏õ‡∏∞‡∏õ‡πä‡∏≤ 20", "‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏™‡∏á‡∏û‡∏£‡∏´‡∏°‡πÅ‡∏•‡∏ô‡∏î‡πå", "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏õ‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏Ø"],
        "‡∏ù‡∏±‡πà‡∏á/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤"]
    },
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 5 ‡∏ñ‡∏∂‡∏á 6": {
        "‡∏ñ‡∏ô‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏à‡∏≤‡∏Å ‡∏õ.5)": ["‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏¢‡∏Å: ‡∏ã‡∏≠‡∏¢ NU Plaza", "‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏¢‡∏Å: ‡∏ã‡∏≠‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏ä‡∏£‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î", "‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏¢‡∏Å: ‡∏ã‡∏≠‡∏¢‡πÇ‡∏•‡∏Å‡∏µ‡∏¢‡πå"],
        "‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏¢‡∏Å‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢": ["‡∏ã‡∏≠‡∏¢‡πÄ‡∏•‡∏µ‡∏¢‡∏ö‡∏£‡∏±‡πâ‡∏ß ‡∏õ.6 (NU1-3/Pyland/‡∏ï‡∏∂‡∏Å‡∏ä‡πâ‡∏≤‡∏á/Tea Shake)"],
        "‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏¢‡∏Å‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤ (‡∏ü‡∏¥‡∏ô‡∏•‡∏µ‡πà‡πÅ‡∏•‡∏ô‡∏î‡πå)": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß", "‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ã‡∏≠‡∏¢‡πÇ‡∏•‡∏ï‡∏±‡∏™ ‡∏õ.5", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡∏ã‡∏≠‡∏¢‡∏û‡∏£‡∏ß‡∏•‡∏±‡∏¢ ‡∏õ.5"],
        "‡πÇ‡∏ã‡∏ô‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß/‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏°‡∏≠": ["‡∏™‡∏∏‡∏î‡∏ã‡∏≠‡∏¢‡∏û‡∏±‡∏ô‡∏î‡∏≤‡∏ß -> ‡∏ã‡∏≠‡∏¢‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏°‡∏≠", "‡∏ù‡∏±‡πà‡∏á‡∏ä‡∏≤‡∏ö‡∏π‡∏Ç‡∏∏‡∏ô‡∏ä‡πâ‡∏≤‡∏á", "‡∏ù‡∏±‡πà‡∏á‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏°‡∏≠", "‡∏ã‡∏≠‡∏¢‡πÇ‡∏ü‡∏°‡∏à‡πã‡∏≤", "‡∏ã‡∏≠‡∏¢‡∏•‡∏≤‡∏ô‡∏≠‡∏µ‡∏™‡∏≤‡∏ô (‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏Å‡∏∞‡∏•‡∏≤)", "‡∏ã‡∏≠‡∏¢‡∏Ñ‡∏≤‡∏£‡πå‡πÅ‡∏Ñ‡∏£‡πå"],
        "‡∏ù‡∏±‡πà‡∏á/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á": ["‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÇ‡∏Å‡∏Æ‡∏∞)", "‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏ñ‡∏≤‡∏î)", "‡∏ù‡∏±‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏∑‡πà‡∏ô", "‡∏ù‡∏±‡πà‡∏á‡∏õ‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏±‡∏ç", "‡∏ó‡∏∞‡∏•‡∏∏‡∏ã‡∏≠‡∏¢‡∏Å‡∏•‡∏≤‡∏á"]
    }
}

# --- 2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gemini & Sheets ---
try:
    genai.configure(api_key=st.secrets["API_KEY"])
    model = genai.GenerativeModel('models/gemini-2.5-flash')
except: st.error("Gemini Connection Error")

def get_sheet():
    scope = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    creds = Credentials.from_service_account_info(st.secrets["gcp_service_account"], scopes=scope)
    return gspread.authorize(creds).open_by_key(st.secrets["SHEET_ID"]).get_worksheet(0)

# --- 3. UI ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Step-by-Step Quiz) ---
st.subheader("üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á")

location = streamlit_geolocation()
lat, lon = location.get('latitude'), location.get('longitude')

if lat and lon:
    # STEP 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π
    gate = st.selectbox("üö© 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π/‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π --"] + list(NU_MAP.keys()))
    
    if gate != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π --":
        # STEP 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ã‡∏≠‡∏¢
        routes = [k for k in NU_MAP[gate].keys() if k != "‡∏ù‡∏±‡πà‡∏á/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"]
        route = st.selectbox("üõ£Ô∏è 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á/‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ã‡∏≠‡∏¢:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á --"] + routes)
        
        if route != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á --":
            # STEP 3: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢
            sub_alley = st.selectbox("üèòÔ∏è 3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏≠‡∏¢/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:", NU_MAP[gate][route])
            
            # STEP 4: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á
            side = st.radio("‚ÜïÔ∏è 4. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:", NU_MAP[gate]["‡∏ù‡∏±‡πà‡∏á/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"])
            
            # STEP 5: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
            detail = st.text_input("‚úçÔ∏è 5. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á/‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï):")
            
            full_data = f"{gate} > {route} > {sub_alley} ({side}) | ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {detail}"
            
            st.info(f"üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: {full_data}")
            
            if st.button("üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"):
                with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'):
                    sheet = get_sheet()
                    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    maps_url = f"https://www.google.com/maps?q={lat},{lon}"
                    
                    # ‡∏´‡∏¢‡∏≠‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á
                    headers = sheet.row_values(1)
                    data_row = [""] * len(headers)
                    for i, h in enumerate(headers):
                        h_l = h.lower()
                        if "‡πÄ‡∏ß‡∏•‡∏≤" in h_l: data_row[i] = now
                        elif "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" in h_l: data_row[i] = full_data
                        elif "‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î" in h_l: data_row[i] = lat
                        elif "‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î" in h_l: data_row[i] = lon
                        elif "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á" in h_l: data_row[i] = maps_url
                        elif "ai" in h_l: data_row[i] = model.generate_content(f"‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡πÜ: {full_data}").text
                    
                    sheet.append_row(data_row)
                    st.balloons()
                    st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
else:
    st.warning("üìç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° GPS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏¢‡πà‡∏≠‡πÑ‡∏ß‡πâ) ---
with st.expander("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°"):
    # (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)
    pass
