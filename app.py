import streamlit as st
import gspread
import pandas as pd
from google.oauth2.service_account import Credentials
from streamlit_geolocation import streamlit_geolocation
from datetime import datetime
import google.generativeai as genai
import re
import pydeck as pdk

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ---
st.set_page_config(page_title="NU Precision Delivery Pro", page_icon="üõµ", layout="wide")

def get_sheets():
    scope = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    creds = Credentials.from_service_account_info(st.secrets["gcp_service_account"], scopes=scope)
    return gspread.authorize(creds).open_by_key(st.secrets["SHEET_ID"])

# ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI (‡πÉ‡∏ä‡πâ 1.5 Flash ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Å‡∏ß‡πà‡∏≤)
try:
    genai.configure(api_key=st.secrets["API_KEY"])
    model = genai.GenerativeModel('models/gemini-1.5-flash')
except:
    st.error("AI Config Error: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Å API_KEY ‡πÉ‡∏ô Secrets")

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ---

def load_mapping_df():
    try:
        sh = get_sheets()
        sheet = sh.worksheet("Mapping")
        data = sheet.get_all_records()
        if not data:
            return pd.DataFrame(columns=["‡∏õ‡∏£‡∏∞‡∏ï‡∏π", "‡∏ù‡∏±‡πà‡∏á‡∏ñ‡∏ô‡∏ô/‡πÇ‡∏ã‡∏ô", "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å", "‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢/‡∏ó‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°", "‡∏ù‡∏±‡πà‡∏á/‡∏à‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"])
        df = pd.DataFrame(data)
        # ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô KeyError
        df.columns = [str(c).strip() for c in df.columns]
        return df.map(lambda x: str(x).strip() if isinstance(x, str) else x)
    except Exception as e:
        st.error(f"‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mapping ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
        return pd.DataFrame(columns=["‡∏õ‡∏£‡∏∞‡∏ï‡∏π", "‡∏ù‡∏±‡πà‡∏á‡∏ñ‡∏ô‡∏ô/‡πÇ‡∏ã‡∏ô", "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å", "‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢/‡∏ó‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°", "‡∏ù‡∏±‡πà‡∏á/‡∏à‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"])

def get_options(df, filters):
    temp_df = df.copy()
    for col, val in filters.items():
        if val and val != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --":
            temp_df = temp_df[temp_df[col] == val]
    target_idx = len(filters)
    if target_idx < len(df.columns):
        return sorted([str(x) for x in temp_df.iloc[:, target_idx].unique() if x and str(x) != "-" and str(x) != ""])
    return []

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ñ‡∏ô‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
def display_precision_map(lat, lon, zoom=18):
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡πÄ‡∏•‡πá‡∏Å‡∏à‡∏¥‡πã‡∏ß 3 ‡πÄ‡∏°‡∏ï‡∏£)
    layer = pdk.Layer(
        "ScatterplotLayer",
        data=pd.DataFrame({'lat': [lat], 'lon': [lon]}),
        get_position='[lon, lat]',
        get_color='[255, 75, 75, 230]', # ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏î‡πÉ‡∏™
        get_radius=3, # ‡∏Ç‡∏ô‡∏≤‡∏î 3 ‡πÄ‡∏°‡∏ï‡∏£ (‡∏à‡∏∏‡∏î‡∏à‡∏∞‡πÄ‡∏•‡πá‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏°‡∏°‡∏≤‡∏Å)
        pickable=True,
    )
    
    # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á
    view_state = pdk.ViewState(latitude=lat, longitude=lon, zoom=zoom, pitch=0)
    
    # ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏™‡πÑ‡∏ï‡∏•‡πå Carto Positron (‡πÄ‡∏´‡πá‡∏ô‡∏ñ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Mapbox Key)
    st.pydeck_chart(pdk.Deck(
        layers=[layer],
        initial_view_state=view_state,
        map_style='carto-positron', # ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ß‡πà‡∏≤‡∏á ‡πÄ‡∏´‡πá‡∏ô‡∏ñ‡∏ô‡∏ô‡∏ä‡∏±‡∏î
        tooltip={"text": "‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á"}
    ))

# --- 3. ‡∏™‡πà‡∏ß‡∏ô UI ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å ---
st.title("üõµ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏ô‡∏™‡πà‡∏á ‡∏°‡∏ô. (Precision & Visual)")
mapping_df = load_mapping_df()

tab1, tab2, tab3 = st.tabs(["üìå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á", "üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ & ‡∏î‡∏π‡∏à‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î", "‚öôÔ∏è Admin Manage"])

# --- TAB 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô (5 ‡∏£‡∏∞‡∏î‡∏±‡∏ö) ---
with tab1:
    location = streamlit_geolocation()
    lat, lon = location.get('latitude'), location.get('longitude')

    if lat and lon:
        st.success(f"üìç GPS ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: {lat:.6f}, {lon:.6f}")
        # ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        display_precision_map(lat, lon, zoom=17) 
        
        gate = st.selectbox("1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + sorted(mapping_df['‡∏õ‡∏£‡∏∞‡∏ï‡∏π'].unique().tolist()))
        
        if gate != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --":
            c1, c2 = st.columns(2)
            with c1:
                zones = get_options(mapping_df, {"‡∏õ‡∏£‡∏∞‡∏ï‡∏π": gate})
                zone = st.selectbox("2. ‡∏ù‡∏±‡πà‡∏á‡∏ñ‡∏ô‡∏ô/‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + zones) if zones else "-"
            with c2:
                m_sois = get_options(mapping_df, {"‡∏õ‡∏£‡∏∞‡∏ï‡∏π": gate, "‡∏ù‡∏±‡πà‡∏á‡∏ñ‡∏ô‡∏ô/‡πÇ‡∏ã‡∏ô": zone}) if zone != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --" else []
                main_soi = st.selectbox("3. ‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + m_sois) if m_sois else "-"

            c3, c4 = st.columns(2)
            with c3:
                s_sois = get_options(mapping_df, {"‡∏õ‡∏£‡∏∞‡∏ï‡∏π": gate, "‡∏ù‡∏±‡πà‡∏á‡∏ñ‡∏ô‡∏ô/‡πÇ‡∏ã‡∏ô": zone, "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å": main_soi}) if main_soi != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --" else []
                sub_soi = st.selectbox("4. ‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢/‡∏ó‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + s_sois) if s_sois else "-"
            with c4:
                dets = get_options(mapping_df, {"‡∏õ‡∏£‡∏∞‡∏ï‡∏π": gate, "‡∏ù‡∏±‡πà‡∏á‡∏ñ‡∏ô‡∏ô/‡πÇ‡∏ã‡∏ô": zone, "‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å": main_soi, "‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢/‡∏ó‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°": sub_soi}) if sub_soi != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --" else []
                detail = st.selectbox("5. ‡∏ù‡∏±‡πà‡∏á/‡∏à‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:", ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --"] + dets) if dets else "-"

            extra = st.text_input("‚úçÔ∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á/‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠/‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô):")

            if st.button("üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î"):
                with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."):
                    try:
                        sh = get_sheets()
                        log_sheet = sh.worksheet("Sheet1")
                        full_info = f"{gate} | {zone} | {main_soi} | {sub_soi} | {detail} | {extra}"
                        now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                        maps_url = f"https://www.google.com/maps?q={lat},{lon}"
                        log_sheet.append_row([now, full_info, lat, lon, maps_url])
                        st.balloons()
                        st.success(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {full_info}")
                    except Exception as e:
                        st.error(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
    else:
        st.warning("üìç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")

# --- TAB 2: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (AI + Fallback + Precision Map) ---
with tab2:
    st.header("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏™‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà")
    query = st.text_input("‡∏ñ‡∏≤‡∏° AI ‡πÄ‡∏ä‡πà‡∏ô '‡∏´‡∏≠‡∏ô‡∏£‡∏¥‡∏®‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏õ‡∏™‡πà‡∏á‡πÑ‡∏´‡∏°', '‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏õ‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4 ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô'")
    
    if st.button("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"):
        if query:
            with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î..."):
                try:
                    sh = get_sheets()
                    history_df = pd.DataFrame(sh.worksheet("Sheet1").get_all_records())
                    history_df.columns = [str(c).strip() for c in history_df.columns]

                    m_lat, m_lon, found_text = None, None, ""

                    # 1. ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ AI ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    try:
                        # ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ AI (‡∏à‡∏≥‡∏Å‡∏±‡∏î 40 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î Token)
                        prompt = f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á: {history_df.tail(40).to_string()}\n‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {query}\n‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÅ‡∏•‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á COORD_FOUND: lat,lon ‡∏ó‡πâ‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö"
                        response = model.generate_content(prompt).text
                        
                        coord_match = re.search(r"COORD_FOUND:\s*([0-9.]+),\s*([0-9.]+)", response)
                        if coord_match:
                            m_lat, m_lon = float(coord_match.group(1)), float(coord_match.group(2))
                            found_text = response.split("COORD_FOUND")[0].strip()
                        else:
                            found_text = response
                    except:
                        # 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á (Fallback) ‡∏´‡∏≤‡∏Å AI ‡∏ï‡∏¥‡∏î Quota
                        st.warning("‚ö†Ô∏è ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ AI ‡πÄ‡∏ï‡πá‡∏°‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á...")
                        results = history_df[history_df['‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'].str.contains(query, case=False, na=False)]
                        if not results.empty:
                            last_hit = results.iloc[-1]
                            m_lat, m_lon = float(last_hit['‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î']), float(last_hit['‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î'])
                            found_text = f"‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: {last_hit['‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å']}"
                        else:
                            found_text = "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"

                    # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
                    st.markdown(f"**ü§ñ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:** {found_text}")
                    
                    # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    if m_lat and m_lon:
                        st.write("---")
                        st.subheader("üì∏ ‡∏†‡∏≤‡∏û‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î (Zoomed Precision)")
                        display_precision_map(m_lat, m_lon, zoom=19) # ‡∏ã‡∏π‡∏°‡∏•‡∏∂‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏∂‡∏Å
                        st.write(f"üîó [‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ Google Maps](https://www.google.com/maps?q={m_lat},{m_lon})")

                except Exception as e:
                    st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {e}")
        else:
            st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤")

# --- TAB 3: Admin (‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ß‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á) ---
with tab3:
    st.header("‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡∏≠‡∏¢ (Admin)")
    if st.text_input("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ Admin PIN:", type="password") == "9999":
        st.subheader("‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î/‡∏ã‡∏≠‡∏¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")
        with st.form("admin_add_form"):
            c1, c2, c3, c4, c5 = st.columns(5)
            a_gate = c1.text_input("1. ‡∏õ‡∏£‡∏∞‡∏ï‡∏π")
            a_zone = c2.text_input("2. ‡∏ù‡∏±‡πà‡∏á‡∏ñ‡∏ô‡∏ô/‡πÇ‡∏ã‡∏ô")
            a_soi = c3.text_input("3. ‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å")
            a_sub = c4.text_input("4. ‡∏ã‡∏≠‡∏¢‡∏¢‡πà‡∏≠‡∏¢/‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°")
            a_det = c5.text_input("5. ‡∏à‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î")
            
            if st.form_submit_button("‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà"):
                if a_gate and a_soi:
                    try:
                        sh = get_sheets()
                        sh.worksheet("Mapping").append_row([a_gate, a_zone, a_soi, a_sub, a_det])
                        st.cache_data.clear()
                        st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
                        st.rerun()
                    except Exception as e:
                        st.error(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
                else:
                    st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• '‡∏õ‡∏£‡∏∞‡∏ï‡∏π' ‡πÅ‡∏•‡∏∞ '‡∏ã‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏Å' ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢")
